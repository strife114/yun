# LNMP+Wordpress+Redis

## 实验环境

| IP              | 节点规划             | 性能  |
| --------------- | -------------------- | ----- |
| 192.168.223.5   | LNMP+Wordpress+redis | 1核2G |
| 192.168.223.6   | LNMP+Wordpress       | 1核2G |
| 192.168.223.101 | Nginx代理            | 2核4G |

## 部署（请在192.168.223.5、192.168.223.6的节点ip做lnmp部署）

### 安装nginx

1. 设置yum源

   ```sh
   vim /etc/yum.repos.d/nginx.repo
   
   [nginx]
   name = nginx repo
   baseurl = https://nginx.org/packages/mainline/centos/7/$basearch/
   gpgcheck = 0
   enabled = 1
   ```

2. 安装

   ```sh
   yum install -y nginx
   ```

3. 修改default.conf文件

   ```sh
    vi /etc/nginx/conf.d/default.conf
    
    server {
    listen 80;
    root /usr/share/nginx/html;
    server_name localhost;
    #charset koi8-r;
    #access_log /var/log/nginx/log/host.access.log main;
    #
    location / {
    index index.php index.html index.htm;
    }
    #error_page 404 /404.html;
    #redirect server error pages to the static page /50x.html
    #
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
    root /usr/share/nginx/html;
    }
    #pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    location ~ .php$ {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
    }
   }
   ```

4. 设置启动和自启

   ```sh
   systemctl start nginx
   systemctl enable nginx
   ```

5. 浏览器访问虚拟机ip

### 安装Mariadb（此处192.168.223.6节点可不安装数据库服务）

1. 查看是否安装

   ```sh
   rpm -qa |grep -i mariadb
   
   
   # 如果有就删除
   yum remove -y mariadb-libs
   ```

2. 设置yum源

   ```sh
   vi /etc/yum.repos.d/MariaDB.repo
   
   [mariadb]
   name = MariaDB
   baseurl = https://mirrors.cloud.tencent.com/mariadb/yum/10.4/centos7-amd64
   gpgkey=https://mirrors.cloud.tencent.com/mariadb/yum/RPM-GPG-KEY-MariaDB
   gpgcheck=1
   ```

3. 下载

   ```sh
   yum -y install  MariaDB-client MariaDB-server
   ```

4. 启动并自启

   ```sh
   systemctl start mariadb
   systemctl enable mariadb
   ```

5. 测试

   ```sh
   mysql
   ```

### 安装PHP

1. 更新yum中php软件源

   ```sh
   rpm -Uvh https://mirrors.cloud.tencent.com/epel/epel-release-latest-7.noarch.rpm
   
   rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
   ```

2. 下载

   ```sh
   yum -y install mod_php72w.x86_64 php72w-cli.x86_64 php72w-common.x86_64 php72w-mysqlnd php72w-fpm.x86_64
   ```

3. 启动并自启

   ```sh
   systemctl start php-fpm
   systemctl enable php-fpm
   ```

4. 创建文件

   ```sh
   vim /usr/share/nginx/html/index.php
   
   <?php
   phpinfo();
   ?>
   ```

5. 重启

   ```sh
   systemctl restart nginx
   ```

6. 测试

   ```sh
   本机ip/index.php
   ```



## 搭建Wordpress（请在192.168.223.5、192.168.223.6节点做wordpress部署）

1. 进入192.168.223.5的数据库

   ```sh
   # 进入数据库
   mysql
   
   # 创建数据库
   create database wordpress;
   # 赋权
   grant all privileges on *.* to "wordpress"@"localhost" identified by '000000';
   # 赋权192.168.223.6的用户权限
   grant all privileges on *.* to "wordpress"@"localhost" identified by '000000';
   # 更新权限
   flush privileges;
   
   # 重启
   systemctl restart mariadb
   ```

2. 删除nginx的html下的所有文件

   ```sh
   rm -rf /usr/share/nginx/html/*
   ```

3. 上传解压wordpress安装包

4. 复制系统文件到网页解析目录下

   ```sh
   # 强制复制wordpress下的所有东西到/usr/share/nginx/html/下
   cp -rf wordpress/*   /usr/share/nginx/html/
   
   cd /usr/share/nginx/html/
   ```

5. 部署wordpress

   ```sh
   # 192.168.223.5
   # 备份
   cp wp-config-sample.php wp-config.php
   vim wp-config.php
   
    21 // ** MySQL
    22 /** WordPress
    23 define('DB_NAME', 'wordpress');
    24
    25 /** MySQL数据库⽤户名 */
    26 define('DB_USER', 'wordpress');
    27
    28 /** MySQL数据库密码 */
    29 define('DB_PASSWORD', '000000');
    30
    31 /** MySQL主机 */
    32 define('DB_HOST', 'localhost');
    33
    34 /** 创建数据表时默认的⽂字编码 */
    35 define('DB_CHARSET', 'utf8');
    
    
    
    
   # 192.168.223.6
    21 // ** MySQL
    22 /** WordPress
    23 define('DB_NAME', 'wordpress');
    24
    25 /** MySQL数据库⽤户名 */
    26 define('DB_USER', 'wordpress');
    27
    28 /** MySQL数据库密码 */
    29 define('DB_PASSWORD', '000000');
    30
    31 /** MySQL主机 */
    32 define('DB_HOST', '192.168.223.5');
    33
    34 /** 创建数据表时默认的⽂字编码 */
    35 define('DB_CHARSET', 'utf8');
    
   ```

6. 赋权

   ```sh
   chmod -R 777 /usr/share/nginx/html/
   ```

7. 查看端口

   ```sh
   netstat -ntlp 
   ```

8. 打开浏览器输入虚拟机ip



## 部署负载均衡(192.168.223.101)

1. 设置yum源

   ```sh
   vim /etc/yum.repos.d/nginx.repo
   
   [nginx]
   name = nginx repo
   baseurl = https://nginx.org/packages/mainline/centos/7/$basearch/
   gpgcheck = 0
   enabled = 1
   ```

2. 安装

   ```sh
   yum install -y nginx
   ```

3. 启动并设置自启

   ```
   systemctl start nginx
   systemctl enable nginx
   ```

4. 修改配置文件

   ```sh
   [root@localhost ~]# cat /etc/nginx/nginx.conf 
   user  nginx;
   worker_processes  auto;
   
   error_log  /var/log/nginx/error.log notice;
   pid        /var/run/nginx.pid;
   
   
   events {
       worker_connections  1024;
   }
   
   
   http {
       include       /etc/nginx/mime.types;
       default_type  application/octet-stream;
   
       log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                         '$status $body_bytes_sent "$http_referer" '
                         '"$http_user_agent" "$http_x_forwarded_for"';
   
       access_log  /var/log/nginx/access.log  main;
   
       sendfile        on;
       #tcp_nopush     on;
   
       keepalive_timeout  65;
   
       #gzip  on;
       upstream  apacheserver{
       server  192.168.223.5;
       server  192.168.223.6;
   }
   server{
       listen  80;
       server_name   www.123.com;
       location  / {
       proxy_pass  http://apacheserver;
       root   html;
       index  index.html  index.htm;
   }
   }
       include /etc/nginx/conf.d/*.conf;
   }
   
   ```

5. 重启服务

   ```
   systemctl restart nginx
   ```

6. 测试

   ```
   vim /usr/share/nginx/html/index.html
   1111
   
   vim /usr/share/nginx/html/index.html
   222
   
   
   # 稍后会在下方有图形展示
   ```

   

## 扩展redis(192.168.223.5)

1. 安装redis

   ```sh
   # yum  -y install  https://mirrors.tuna.tsinghua.edu.cn/remi/enterprise/remi-release-7.rpm
   # 修改yum源
   # vim /etc/yum.repos.d/remi.repo
   修改如下：
   [remi]
   name=Remi's RPM repository for Enterprise Linux 7 - $basearch
   #baseurl=http://rpms.remirepo.net/enterprise/7/remi/$basearch/
   #mirrorlist=https://rpms.remirepo.net/enterprise/7/remi/httpsmirror
   mirrorlist=http://cdn.remirepo.net/enterprise/7/remi/mirror
   enabled=1        这里原本默认是0的修改为1开启
   gpgcheck=1
   gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-remi
   
   # 安装redis
   [root@localhost ~]# yum  -y install redis-5*
   ```

2. 安装php-redis连接驱动

   ```sh
   # yum -y install php-redis
   
   
   
   # 注意
   1. 会出现依赖包冲突问题
   
   # 解决方法
   1. 安装所有php72w前缀
      yum install -y php72w*
   ```

3. 修改配置文件（192.168.223.5和192.168.223.6的wp-config.php都要修改）

   ```sh
   vim /usr/share/nginx/html/wp-config.php
   # 在最后一行加上三行
   define("FS_METHOD", "direct");
   define("FS_CHMOD_DIR", 0777);
   define("FS_CHMOD_FILE", 0777);
   
   
   # 注意
   1. 这里主要是redis插件ftp服务使用
   ```

4. 添加插件

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/redis1.png)

5. 指定redis服务器ip（192.168.223.5）

   ```sh
   vim /usr/share/nginx/html/wp-content/plugins/redis-cache/includes/object-cache.php
   # 搜索6379即可找到
    protected function build_parameters() {
           $parameters = [
               'scheme' => 'tcp',
               'host' => '127.0.0.1',
               'port' => 6379,
               'database' => 0,
               'timeout' => 1,
               'read_timeout' => 1,
               'retry_interval' => null,
               'persistent' => false,
           ];
           
           
   # 注意
   1. 因为这里本人配置到本机redis，所以不必修改
   ```

6. 启动服务

   ```sh
   systemctl start redis
   systemctl enable redis
   ```

7. 查看缓存信息

   ```sh
   [root@localhost html]# redis-cli
   127.0.0.1:6379> KEYS *
    1) "wp:site-transient:update_plugins"
    2) "wp:options:nonce_key"
    3) "wp:options:can_compress_scripts"
    4) "wp:options:nonce_salt"
    5) "wp:post_tag_relationships:1"
    6) "wp:site-transient:poptags_40cd750bba9870f18aada2478b24840a"
    7) "wp:terms:get_terms-7b517923119523f1d371fe25128d21f1-0.81377000 1683191641"
    8) "wp:terms:get_terms-d2f0d42213c61ca358a12deb1ac5bd5d-0.81377000 1683191641"
    9) "wp:options:auth_salt"
   10) "wp:comment:get_comment_child_ids-1-884eb2c92eb464aa20f51bacdb7ddae8-0.82581200 1683191641"
   11) "wp:transient:is_multi_author"
   12) "wp:redis-cache:metrics"
   13) "wp:terms:get_terms-4a07b3c34e4f5e405db2481c939e29b5-0.81377000 1683191641"
   14) "wp:terms:get_terms-994fbdb7c0aa097dcd83686e00184577-0.81377000 1683191641"
   15) "wp:users:1"
   16) "wp:user_meta:1"
   17) "wp:comment:get_comments-9503889e74633f729bf0ed7217c233a4-0.82581200 1683191641"
   18) "wp:terms:1"
   19) "wp:comment:last_changed"
   20) "wp:comment:get_comments-95c334f059a78c67a1c0073fd7e467bc-0.82581200 1683191641"
   21) "wp:post_format_relationships:1"
   22) "wp:site-transient:update_themes"
   23) "wp:site-transient:available_translations"
   24) "wp:options:notoptions"
   25) "wp:useremail:admin@admin.com"
   26) "wp:post_meta:1"
   27) "wp:site-transient:update_core"
   28) "wp:category_relationships:1"
   29) "wp:comment:1"
   30) "wp:comment:get_comments-884eb2c92eb464aa20f51bacdb7ddae8-0.82581200 1683191641"
   31) "wp:default:is_blog_installed"
   32) "wp:posts:last_changed"
   33) "wp:userslugs:strife"
   34) "wp:transient:twentyseventeen_categories"
   35) "wp:options:logged_in_key"
   36) "wp:options:logged_in_salt"
   37) "wp:transient:plugin_slugs"
   38) "wp:terms:get_terms-55e00a2479938f82355c3418aae351a9-0.81377000 1683191641"
   39) "wp:posts:wp_get_archives-53058f6b83972cfc3253e30ef06fcaa9-0.83946400 1683191641"
   40) "wp:options:theme_mods_twentyseventeen"
   41) "wp:options:alloptions"
   42) "wp:options:auth_key"
   43) "wp:options:recently_edited"
   44) "wp:term_meta:1"
   45) "wp:userlogins:strife"
   46) "wp:posts:1"
   47) "wp:terms:last_changed"
   ```

   

## 验证图片

1. 负载均衡

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/fuzai1.png)

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/fuzai2.png)

2. redis

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/redis2.png)

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/redis3.png)







# Zabbix

## 实验环境

| IP              | 主机       | 节点规划                          |
| --------------- | ---------- | --------------------------------- |
| 192.168.223.100 | server     | zabbix-server,zabbix-agent        |
| 192.168.223.5   | client     | LNMP+Wordpress+redis+zabbix-agent |
| 192.168.223.101 | 代理       | Nginx+负载均衡                    |
| 192.168.223.7   | jumpserver | jumpserver堡垒机                  |



## zabbix部署

### 部署LNMP

#### Nginx

1. 添加nginx的yum源

   ```
   [root@server ~]# vim /etc/yum.repos.d/nginx.repo
   [nginx-stable]
   name=nginx stable repo
   baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
   gpgcheck=0
   enabled=1
   ```

2. 清除缓存并下载nginx，然后开启服务并设置自启

   ```
   [root@server ~]# yum clean all && yum makecache fast
   [root@server ~]# yum install -y nginx
   [root@server ~]# systemctl start nginx.service && systemctl enable nginx.service
   ```

3. 浏览器访问本机ip测试

#### Mariadb

1. 下载mariadb

   ```
   [root@server ~]# yum -y install mariadb-server mariadb
   ```

2. 开启服务并自启

   ```
   [root@server ~]# systemctl start mariadb.service && systemctl enable mariadb.service
   
   
   # 验证
   [root@server ~]# netstat -lntp
   Active Internet connections (only servers)
   Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
   tcp        0      0 0.0.0.0:3306            0.0.0.0:*               LISTEN      1906/mysqld         
   tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      2762/nginx: master  
   tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      970/sshd            
   tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1179/master         
   tcp6       0      0 :::22                   :::*                    LISTEN      970/sshd            
   tcp6       0      0 ::1:25                  :::*                    LISTEN      1179/master         
   ```

3. 执行mysql安装配置向导

   ```
   [root@server ~]# mysql_secure_installation
   
   NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MariaDB
         SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!
   
   In order to log into MariaDB to secure it, we'll need the current
   password for the root user.  If you've just installed MariaDB, and
   you haven't set the root password yet, the password will be blank,
   so you should just press enter here.
   
   Enter current password for root (enter for none): 		'//回车'
   OK, successfully used password, moving on...
   
   Setting the root password ensures that nobody can log into the MariaDB
   root user without the proper authorisation.
   
   Set root password? [Y/n] y		'//设置密码'
   New password: 
   Re-enter new password: 		'//确认密码'
   Password updated successfully!
   Reloading privilege tables..
    ... Success!
   
   
   By default, a MariaDB installation has an anonymous user, allowing anyone
   to log into MariaDB without having to have a user account created for
   them.  This is intended only for testing, and to make the installation
   go a bit smoother.  You should remove them before moving into a
   production environment.
   
   Remove anonymous users? [Y/n] y		'//是否删除匿名用户'
    ... Success!
   
   Normally, root should only be allowed to connect from 'localhost'.  This
   ensures that someone cannot guess at the root password from the network.
   
   Disallow root login remotely? [Y/n] y		'//是否禁止root远程登录'
    ... Success!
   
   By default, MariaDB comes with a database named 'test' that anyone can
   access.  This is also intended only for testing, and should be removed
   before moving into a production environment.
   
   Remove test database and access to it? [Y/n] n		'//是否删除test数据库'
    ... skipping.
   
   Reloading the privilege tables will ensure that all changes made so far
   will take effect immediately.
   
   Reload privilege tables now? [Y/n] y		'//是否重新加载权限表'
    ... Success!
   
   Cleaning up...
   
   All done!  If you've completed all of the above steps, your MariaDB
   installation should now be secure.
   
   Thanks for using MariaDB!
   ```

4. 测试登录

   ```
   [root@server ~]# mysql -uroot -p000000
   ```

#### PHP

1. 下载安装

   ```
   [root@server ~]# rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
   [root@server ~]# rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
   [root@server ~]# yum -y install php72w php72w-devel php72w-fpm php72w-gd php72w-mbstring php72w-mysql
   
   # 查看版本
   [root@server ~]# php -v		
   ```

2. 修改php网页文件

   ```
   [root@server ~]# vim /etc/php-fpm.d/www.conf
   # 第8行，修改
   user = nginx
   # 第10行，修改
   group = nginx
   ```

3. 修改nginx配置文件

   ```
   [root@server ~]# vim /etc/nginx/conf.d/default.conf
   
   # 第10行，添加index.php文件
   index  index.html index.htm index.php;
   # 31-37行，取消注释并修改，配置php请求传送到后端的php-fpm模块的配置
   location ~ \.php$ {
       # 修改站点目录
   	root           /usr/share/nginx/html;
   	fastcgi_pass   127.0.0.1:9000;
   	fastcgi_index  index.php;
   	# 将fastcgi_param中的/scripts改为$document_root，root是配置php程序纺织的根目录
   	fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;	
   	include        fastcgi_params;
   }
   ```

4. 优化php配置文件

   ```
   [root@server ~]# vim /etc/php.ini
   
   # 202行改为On，支持php短标签
   short_open_tag = On
   # 359修改为Off，隐藏php版本
   expose_php = Off
   
   # 以下都是zabbix的配置要求
   # 368行，执行时间，在一个程序执行的过程中能够等待的执行时间，执行时间过程中如果没有执行完会结束该程序，以防出现卡死，默认30秒'
   max_execution_time = 300
   # 378行，接受数据的等待时间
   max_input_time = 300
   # 389行，每个脚本的占用内存限制
   memory_limit = 128M
   # 656行，post数据的最大限制
   post_max_size = 16M
   # 799，下载文件的大小限制
   upload_max_filesize = 2M
   # 800行添加此句，可以用$HTTP_RAW_POST_DATA接受post raw data（原始未处理数据）
   always_populate_raw_post_data = -1
   # 878行，修改时区为上海
   date.timezone = Asia/Shanghai
   ```

5. 启动服务并设置自启

   ```
   [root@server ~]#  systemctl start php-fpm && systemctl enable php-fpm && systemctl restart nginx
   
   # 查看端口
   [root@server ~]# netstat -natp|grep 9000
   ```

6. 测试

   ```
   [root@server ~]# vim /usr/share/nginx/html/info.php	
   
   <?php
    phpinfo();
   ?>
   
   # 访问网页192.168.223.100/info.php测试
   ```

7. 测试数据库是否连接

   ```sh
   [root@server ~]# vim /usr/share/nginx/html/info.php		'//重新修改首页文件，测试数据库是否连接'
   
   <?php
    $link=mysqli_connect('127.0.0.1','root','000000');
    if ($link) echo "连接成功";
    else echo "连接失败";
   ?>
   
   
   
   # 访问网页192.168.223.100/info.php测试
   ```

8. 创建zabbix数据库

   ```sh
   [root@server ~]# mysql -uroot -p123456
   mysql> CREATE DATABASE zabbix character set utf8 collate utf8_bin;
   mysql> GRANT all privileges ON *.* TO 'zabbix'@'%' IDENTIFIED BY '123456';
   mysql> flush privileges;
   mysql> exit;
   
   
   [root@server ~]# vim /usr/share/nginx/html/info.php
   <?php
    $link=mysqli_connect('127.0.0.1','zabbix','123456');
    if ($link) echo "zabbix数据库连接成功";
    else echo "连接失败";
   ?>
   
   # 访问网页【192.168.223.100/info.php】测试
   ```

### 部署Zabbix Server

1. 下载安装

   ```sh
   # 安装升级zabbix存储库
   [root@server ~]# rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-2.el7.noarch.rpm
   [root@server ~]# yum clean all
   # 安装Zabbix server，Web前端，agent
   [root@server ~]# yum -y install zabbix-server-mysql zabbix-web-mysql zabbix-agent
   ```

2. 配置数据库

   ```sh
   # 导入初始架构和数据
   [root@server ~]# zcat /usr/share/doc/zabbix-server-mysql-4.0.45/create.sql.gz | mysql -uzabbix -p123456 zabbix
   [root@server ~]# mysql -uroot -p123456
   mysql> show databases;
   mysql> use zabbix;
   mysql> show tables;
   
   # 将zabbix配置文件复制
   [root@server ~]# rm -rf /usr/share/nginx/html/*
   [root@server ~]# cp -r /usr/share/zabbix/ /usr/share/nginx/html/
   [root@server ~]# cd /usr/share/nginx/html
   [root@server html]# cd zabbix
   [root@server zabbix]# mv * ../
   [root@server zabbix]# cd ..
   [root@server html]# rm -rf zabbix
   ```

3. 赋权

   ```sh
   [root@server ~]# chown -R zabbix:zabbix /etc/zabbix
   [root@server ~]# chown -R zabbix:zabbix /usr/share/nginx/
   [root@server ~]# chown -R zabbix:zabbix /usr/lib/zabbix/
   
   [root@server ~]# chmod -R 755 /etc/zabbix/web/
   [root@server ~]# chmod -R 777 /var/lib/php/session/
   ```

4. 优化配置文件

   ```sh
   [root@server ~]# vim /etc/zabbix/zabbix_server.conf
   # 91行，取消注释
   DBHost=localhost		
   # 124行，设置密码
   DBPassword=123456		
   ```

5. 开启服务并设置自启

   ```sh
   [root@server ~]# systemctl start zabbix-server.service && systemctl enable zabbix-server.service 
   [root@server ~]# systemctl start zabbix-agent.service && systemctl enable zabbix-agent.service
   
   # 查看端口
   [root@server ~]# netstat -natp|grep 10051
   [root@server ~]# netstat -natp|grep 'zabbix'
   ```

6. 重启php和nginx

   ```sh
   [root@server ~]# systemctl restart php-fpm.service && systemctl restart nginx
   ```

7. 浏览器访问ip，用户名：Admin，密码：zabbix

8. 补充

   ```sh
   # 注意！
   1. 我们可能会遇见无法打开界面的情况，可以尝试以下几种方式，这种方式是直接指定打开文件
     ip/index.php
     ip/setup.php
   2. 如果上述方法无法解决，请查看日志文件，可能会出现某个位置关于zabbix的文件的报错，大概率是权限不足
      tailf /var/log/nginx/error.log
   3. 将nginx的html文件中的所有文件删除，并重复此操作
      cp -r /usr/share/zabbix/ /usr/share/nginx/html/
      cd /usr/share/nginx/html
      cd zabbix
      mv * ../
      cd ..
      rm -rf zabbix
    4. 建议生成一个较为干净的环境重试
   ```

### zabbix初始化

![img](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/zabbix/chushihua1.png)

![img](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/zabbix/chushihua2.png)

![img](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/zabbix/chushihua3.png)

![img](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/zabbix/chushihua4.png)

![img](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/zabbix/chushihua5.png)

![img](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/zabbix/chushihua6.png)

![img](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/zabbix/chushihua7.png)

![img](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/zabbix/chushihua8.png)

### 部署Client代理端

1. 下载安装

   ```sh
   [root@client ~]# rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-2.el7.noarch.rpm
   
   [root@client ~]# yum -y install zabbix-agent
   ```

2. 修改zabbix代理配置文件

   ```sh
   [root@client ~]# vim /etc/zabbix/zabbix_agentd.conf		'//修改zabbix代理配置文件'
   # 98行，指向监控服务器地址
   Server=192.168.223.100
   # 139行，指向监控服务器地址
   ServerActive=192.168.223.100
   # 150行，指向client名称
   Hostname=client
   ```

3. 开启服务并自启

   ```sh
   [root@client ~]# systemctl start zabbix-agent.service && systemctl enable zabbix-agent.service
   
   # 查看端口
   [root@client ~]# netstat -ntap |grep 'zabbix'
   tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      11706/zabbix_agentd 
   tcp6       0      0 :::10050                :::*                    LISTEN      11706/zabbix_agentd
   ```

4. 赋权server端用户权限（为了保证server端能访问到客户端数据库）

   ```sh
   MariaDB [(none)]> create user zabbix@'127.0.0.1' identified by '123456';
   MariaDB [(none)]> grant all privileges on *.* to "zabbix"@"192.168.223.100" identified by "123456";
   MariaDB [(none)]> grant all privileges on *.* to "zabbix"@localhost identified by "123456";
   MariaDB [(none)]> flush privileges;
   ```

5. 添加主机

   配置--》主机--》创建主机

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zazhuji1.png)



## 监控Mysql数据库（192.168.223.5）

1. 添加配置文件

   ```sh
   [root@client zabbix]# cat /etc/zabbix/.my.cnf 
   [client]
   user=zabbix
   host=localhost
   password=123456
   ```

2. 测试配置文件

   ```sh
   [root@client zabbix]# HOME=/etc/zabbix/ mysqladmin ping
   mysqld is alive
   ```

3. 修改zabbix agent配置文件

   ```sh
   [root@client zabbix]# vim zabbix_agentd.d/userparameter_mysql.conf
   # 将第五行改为如下
   UserParameter=mysql.status[*],echo "show global status where Variable_name='$1';" | HOME=/etc/zabbix mysql -N | awk '{print $$2}'
   ```

4. 重启服务

   ```
   systemctl restart zabbix-agent.service
   ```

5. 添加模板

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zazhuji2.png)

6. 测试（后面会有图文展示）

7. server端测试

   ```sh
   [root@localhost web]# zabbix_get -s 192.168.223.5 -k 'mysql.status[Uptime]'
   59398
   [root@localhost web]# zabbix_get -s 192.168.223.5 -k 'mysql.status[Com_update]'
   10
   
   
   
   # 注意
   1.如果没有命令则下载
     [root@server scripts]# rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm
     [root@server scripts]# yum clean all
     [root@server scripts]# yum install zabbix-get
   ```

   







## 监控Nginx（192.168.223.5）

1. 修改nginx配置文件

   ```sh
   [root@client zabbix]# cat  /etc/nginx/conf.d/default.conf
    server {
    listen 80;
    root /usr/share/nginx/html;
    server_name localhost;
    #charset koi8-r;
    #access_log /var/log/nginx/log/host.access.log main;
    #
    location / {
    index index.php index.html index.htm;
    }
    location /nginx_status {
           stub_status on;
           access_log off;
   }
    #error_page 404 /404.html;
    #redirect server error pages to the static page /50x.html
    #
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
    root /usr/share/nginx/html;
    }
    #pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    location ~ .php$ {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
    }
   }
   ```

2. 重启服务

   ```sh
   [root@client zabbix]# systemctl restart nginx
   ```

3. 编写监控脚本

   ```sh
   [root@client zabbix]#  mkdir /home/scripts
   [root@client zabbix]#  vim /home/scripts/nginx_status.sh
   #date: 2020-01-18
   # Description：Zabbix4.0监控Nginx1.16.1性能以及进程状态
   # Note：此脚本需要配置在被监控端
   
   HOST="192.168.223.5"
   PORT="80"
   
   # 检测Nginx进程是否存在
   function ping {
       /sbin/pidof nginx | wc -l
   }
   
   # 检测Nginx性能
   function active {
       /usr/bin/curl "http://$HOST:$PORT/nginx_status/" 2>/dev/null| grep 'Active' | awk '{print $NF}'
   }
   function reading {
       /usr/bin/curl "http://$HOST:$PORT/nginx_status/" 2>/dev/null| grep 'Reading' | awk '{print $2}'
   }
   function writing {
       /usr/bin/curl "http://$HOST:$PORT/nginx_status/" 2>/dev/null| grep 'Writing' | awk '{print $4}'
   }
   function waiting {
       /usr/bin/curl "http://$HOST:$PORT/nginx_status/" 2>/dev/null| grep 'Waiting' | awk '{print $6}'
   }
   function accepts {
       /usr/bin/curl "http://$HOST:$PORT/nginx_status/" 2>/dev/null| awk NR==3 | awk '{print $1}'
   }
   function handled {
       /usr/bin/curl "http://$HOST:$PORT/nginx_status/" 2>/dev/null| awk NR==3 | awk '{print $2}'
   }
   function requests {
       /usr/bin/curl "http://$HOST:$PORT/nginx_status/" 2>/dev/null| awk NR==3 | awk '{print $3}'
   }
   
   $1
   
   ```

4. 赋权

   ```sh
   [root@client zabbix]# chmod 755 /home/scripts/nginx_status.sh
   ```

5. 本地测试

   ```sh
   [root@client zabbix]# sh /home/scripts/nginx_status.sh active
   1
   ```

6. 定义监控key

   ```sh
   [root@client zabbix]# vim /etc/zabbix/zabbix_agentd.conf
   # 找到如下类似的变量，并手动添加
   UnsafeUserParameters=1
   UserParameter=nginx.status[*],/home/scripts/nginx_status.sh $1
   ```

7. 重启zabbix agent

   ```sh
   [root@client zabbix]#systemctl restart zabbix-agent
   ```

8. 服务端获取数据

   ```sh
   [root@localhost web]# zabbix_get -s 192.168.223.5 -k nginx.status[active]
   1
   ```

9. 创建模板

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/zabbix/nginxjk1.png)

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zanginx1.png)

10. 创建应用集

    ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zanginx2.png)

11. 创建监控项

    ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/zabbix/nginxjk6.png)

     在监控脚本中一共定义了七个监控项，所以这里需要创建七个，重复上方步骤即可

    12. 为监控主机添加模板
    
        ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zanginx3.png)
    
    13. 验证（后续有测试图片）
    
    
    
    
    
    

## 监控负载均衡器（192.168.223.101）

1. 编写监控负载均衡器状态的脚本（192.168.223.101）

   ```sh
   [root@localhost ~]# cat /opt/1.sh 
   #!/bin/bash
   NGINX_HOST="192.168.223.101"
   NGINX_PORT="80"
   CURRENT_CONN=$(curl -s "http://$NGINX_HOST:$NGINX_PORT/nginx_status" | grep 'Active' | awk '{print $NF}')
   if [ "$CURRENT_CONN" -gt "0" ]; then
       echo "1"
   else
       echo "0
   "
   fi
   ```

2. 修改nginx配置文件（192.168.223.6）

   ```sh
   [root@localhost ~]# vim /etc/nginx/conf.d/default.conf
    server {
    listen 80;
    root /usr/share/nginx/html;
    server_name localhost;
    #charset koi8-r;
    #access_log /var/log/nginx/log/host.access.log main;
    #
    location / {
    index index.php index.html index.htm;
    }
    location /nginx_status {
           stub_status on;
           access_log off;
       }
    #error_page 404 /404.html;
    #redirect server error pages to the static page /50x.html
    #
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
    root /usr/share/nginx/html;
    }
    #pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    location ~ .php$ {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
    }
   }
   
   ```

3. 下载zabbix客户端

   ```sh
   [root@client101 ~]# rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-2.el7.noarch.rpm
   
   [root@client101 ~]# yum -y install zabbix-agent
   ```

4. 修改代理配置文件

   ```sh
   [root@client101 ~]# vim /etc/zabbix/zabbix_agentd.conf		'//修改zabbix代理配置文件'
   # 98行，指向监控服务器地址
   Server=192.168.223.100
   # 139行，指向监控服务器地址
   ServerActive=192.168.223.100
   # 150行，指向client名称
   Hostname=client101
   
   
   
   # 指定脚本文件
   [root@client101 ~]# vim /etc/zabbix/zabbix_agentd.conf
   UnsafeUserParameters=1
   
   ### Option: UserParameter
   #       User-defined parameter to monitor. There can be several user-defined parameters.
   #       Format: UserParameter=<key>,<shell command>
   #       See 'zabbix_agentd' directory for examples.
   #
   # Mandatory: no
   # Default:
   UserParameter=nginx.fuzai, bash /opt/1.sh
   ```

5. 开启服务并设置自启

   ```sh
   [root@client101 ~]# systemctl start zabbix-agent.service && systemctl enable zabbix-agent.service
   ```

6. server端测试

   ```sh
   [root@localhost web]# zabbix_get -s 192.168.223.101 -k nginx.fuzai
   1
   ```

7. 创建主机（看上文部署client客户端）

8. 添加监控项

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zafuzai1.png)

9. 设置触发器

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zafuzai2.png)

10. 测试（后续有图片）





## 监控jumpserver状态（192.168.223.7）

1. 部署jumpserver

   ```sh
   [root@jumpserver ~]# curl -sSL https://resource.fit2cloud.com/jumpserver/jumpserver/releases/latest/download/quick_start.sh | bash
   ```

   

2. 配置zabbix客户端

   ```sh
   [root@jumpserver ~]# rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-2.el7.noarch.rpm
   
   [root@jumpserver jumpserver-installer-v3.2.1]# yum -y install zabbix-agent
   ```

3. 修改zabbix代理配置文件

   ```sh
   [root@jumpserver jumpserver-installer-v3.2.1]# vim /etc/zabbix/zabbix_agentd.conf		'//修改zabbix代理配置文件'
   Server=192.168.223.100
   ServerActive=192.168.223.100
   Hostname=jumpserver
   
   [root@jumpserver jumpserver-installer-v3.2.1]# vim /etc/zabbix/zabbix_agentd.conf
   UnsafeUserParameters=1
   
   ### Option: UserParameter
   #       User-defined parameter to monitor. There can be several user-defined parameters.
   #       Format: UserParameter=<key>,<shell command>
   #       See 'zabbix_agentd' directory for examples.
   #
   # Mandatory: no
   # Default:
   UserParameter=jumpserver.state, bash /opt/jump.sh
   
   ```

4. 开启服务并自启

   ```sh
   [root@jumpserver ~]# systemctl start zabbix-agent.service && systemctl enable zabbix-agent.service
   ```

5. 编写监控脚本

   ```sh
   [root@jumpserver opt]# cat jump.sh 
   #!/bin/bash
   fdy=`ps aux |grep jumpserver | wc -l`
   if [ $fdy -ge 2 ];then
   	echo 1
   else
   	echo 0
   fi
   ```

6. server端测试

   ```sh
   [root@localhost web]# zabbix_get -s 192.168.223.7 -k jumpserver.state
   1
   ```

7. 创建主机（参照上文）

8. 创建一个名为jumpserver的应用集（参照上文）

9. 创建监控项

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/jump3.png)

10. 创建触发器

    ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/jump4.png)

11. 测试（后续有图片）







## 验证图片

### MySQL

1. server端命令测试

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zamysql1.png)

2. 图形化界面测试

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zamysql2.png)

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zamysql3.png)

### Nginx

1. server端key值测试

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zanginx4.png)

2. client本机验证

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zanginx5.png)

3. web界面验证

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zanginx6.png)

### 负载均衡

1. 宕机状态

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zafuzai3.png)

2. 启动状态

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/zafuzai4.png)

### jumpserver

1. 宕机状态

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/jump2.png)

2. 启动状态

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/jump1.png)





# LOKI

## 实验环境

| IP              | 主机                    | 节点规划                               |
| --------------- | ----------------------- | -------------------------------------- |
| 192.168.223.100 | server                  | zabbix-server,zabbix-agent             |
| 192.168.223.5   | client                  | LNMP+Wordpress+redis+zabbix-agent      |
| 192.168.223.101 | 代理、L**oki主控节点**  | Nginx+负载均衡+loki、grafana、promtail |
| 192.168.223.7   | jumpserver              | jumpserver堡垒机                       |
| 192.168.223.6   | LNMP+Wordpress+promtail | 被监控日志节点                         |



## loki部署

1. 主节点下载组件

2. 解压

   ```sh
   [root@client101 ~]# yum install -y unzip
   [root@client101 ~]# unzip loki-linux-amd64.zip
   [root@client101 ~]# unzip promtail-linux-amd64.zip
   ```

3. 自定义loki配置文件

   ```sh
   [root@client101 ~]# cat loki.yaml
   auth_enabled: false
   
   server:
     http_listen_port: 3100
   
   ingester:
     lifecycler:
       address: 127.0.0.1
       ring:
         kvstore:
           store: inmemory
         replication_factor: 1
       final_sleep: 0s
     chunk_idle_period: 5m
     chunk_retain_period: 30s
   
   schema_config:
     configs:
       - from: 2018-04-15
         store: boltdb
         object_store: filesystem
         schema: v9
         index:
           prefix: index_
           period: 168h
   
   storage_config:
     boltdb:
       directory: /tmp/loki/index
   
     filesystem:
       directory: /tmp/loki/chunks
   
   limits_config:
     enforce_metric_name: false
     reject_old_samples: true
     reject_old_samples_max_age: 168h
   
   #chunk_store_config:
   ##  max_look_back_period: 0
   #
   ##table_manager:
   ##  chunk_tables_provisioning:
   ##    inactive_read_throughput: 0
   ##    inactive_write_throughput: 0
   ##    provisioned_read_throughput: 0
   ##    provisioned_write_throughput: 0
   ##  index_tables_provisioning:
   ##    inactive_read_throughput: 0
   ##    inactive_write_throughput: 0
   ##    provisioned_read_throughput: 0
   ##    provisioned_write_throughput: 0
   ##  retention_deletes_enabled: false
   ##  retention_period: 0
   ```

4. 自定义promtail配置文件

   ```sh
   [root@client101 ~]# cat promtail.yaml 
   server:
     http_listen_port: 9080
     grpc_listen_port: 0
   
   positions:
     filename: /tmp/positions.yaml
   
   clients:
     - url: http://127.0.0.1:3100/loki/api/v1/push
   
   scrape_configs:
     - job_name: linux
       static_configs:
         - targets:
             - localhost
           labels:
              job: messages
              host: localhost
              __path__: /var/log/messages*
   
   ```

5. 安装grafana

   ```sh
   # 安装依赖
   [root@client101 ~]# yum install initscripts fontconfig  
   [root@client101 ~]# yum install freetype
   [root@client101 ~]# yum install urw-fonts
   
   #安装
   [root@client101 ~]# rpm -ivh grafana-6.7.4-1.x86_64.rpm
   ```

6. 启动loki

   ```sh
   [root@client101 ~]# systemctl start grafana-server.service
   ```

7. 启动loki组件

   ```sh
   [root@client101 ~]# nohup ./loki-linux-amd64 -config.file=/root/loki.yaml & 
   [1] 7533
   [root@client101 ~]# nohup: ignoring input and appending output to ‘nohup.out’
   ^C
   [root@client101 ~]# netstat -lntp
   Active Internet connections (only servers)
   Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
   tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      5339/nginx: master  
   tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      959/sshd            
   tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1118/master         
   tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      3307/zabbix_agentd  
   tcp6       0      0 :::9095                 :::*                    LISTEN      7533/./loki-linux-a 
   tcp6       0      0 :::22                   :::*                    LISTEN      959/sshd            
   tcp6       0      0 :::3000                 :::*                    LISTEN      7489/grafana-server 
   tcp6       0      0 ::1:25                  :::*                    LISTEN      1118/master         
   tcp6       0      0 :::3100                 :::*                    LISTEN      7533/./loki-linux-a 
   tcp6       0      0 :::10050                :::*                    LISTEN      3307/zabbix_agentd  
   ```

8. 启动promtail组件

   ```sh
   [root@client101 ~]# nohup ./promtail-linux-amd64 -config.file=/root/promtail.yaml &
   [2] 7600
   [root@client101 ~]# nohup: ignoring input and appending output to ‘nohup.out’
   ^C
   [root@client101 ~]# netstat -lntp
   Active Internet connections (only servers)
   Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
   tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      5339/nginx: master  
   tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      959/sshd            
   tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1118/master         
   tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      3307/zabbix_agentd  
   tcp6       0      0 :::9095                 :::*                    LISTEN      7533/./loki-linux-a 
   tcp6       0      0 :::35147                :::*                    LISTEN      7600/./promtail-lin 
   tcp6       0      0 :::22                   :::*                    LISTEN      959/sshd            
   tcp6       0      0 :::9080                 :::*                    LISTEN      7600/./promtail-lin 
   tcp6       0      0 :::3000                 :::*                    LISTEN      7489/grafana-server 
   tcp6       0      0 ::1:25                  :::*                    LISTEN      1118/master         
   tcp6       0      0 :::3100                 :::*                    LISTEN      7533/./loki-linux-a 
   tcp6       0      0 :::10050                :::*                    LISTEN      3307/zabbix_agentd  
   ```

9. 重启loki

   ```sh
   [root@client101 ~]# systemctl restart grafana-server
   ```

10. web界面访问主控节点ip:3000

    ```
    admin:admin
    password:admin
    ```

11. 创建数据源

    ![image-20230411100718960](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/LOKI/data1)

    ![image-20230411100846582](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/LOKI/data2)

    ![image-20230411100935749](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/LOKI/data3)

12. 获取日志

    ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/loki1.png)

## 获取异端nginx日志

1. 获取promtail安装包

2. 部署服务

   ```
   [root@localhost ~]# yum install -y unzip
   [root@localhost ~]# unzip promtail-linux-amd64.zip
   ```

3. 定义配置文件

   ```sh
   server:
     http_listen_port: 9080
     grpc_listen_port: 0
   
   positions:
     filename: /tmp/positions.yaml
   
   clients:
     - url: http://192.168.223.101:3100/loki/api/v1/push
   
   scrape_configs:
     - job_name: WEB
       static_configs:
         - targets:
             - localhost
           labels:
              job: apache
              host: localhost
              __path__: /var/log/nginx/*.log
   
   ```

4. 启动服务

   ```sh
   [root@localhost ~]#  nohup ./promtail-linux-amd64 -config.file=/root/promtail.yaml &
   [1] 14490
   [root@localhost ~]# nohup: ignoring input and appending output to ‘nohup.out’
   ^C
   [root@localhost ~]# netstat -lntp
   Active Internet connections (only servers)
   Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
   tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      920/sshd            
   tcp        0      0 127.0.0.1:9000          0.0.0.0:*               LISTEN      12761/php-fpm: mast 
   tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      14369/nginx: master 
   tcp6       0      0 :::22                   :::*                    LISTEN      920/sshd            
   tcp6       0      0 :::42679                :::*                    LISTEN      14490/./promtail-li 
   tcp6       0      0 :::9080                 :::*                    LISTEN      14490/./promtail-li 
   ```

5. 重启主控节点服务

   ```sh
   [root@client101 ~]# systemctl start grafana-server.service
   ```

6. 测试（后面有图片）





## 验证图片

1. 获取nginx综合信息
   因为前面配置文件声明的是apace，所以这里的job也是一样

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/loki3.png)

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/loki2.png)

2. 获取单个日志信息

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/loki4.png)

   ![](https://gitee.com/fan-dongyuan/ty-gallery/raw/master/%E5%B7%A5%E5%9D%8A%E5%9B%BE/%E8%80%83%E8%AF%95/loki5.png)
